/**
 * @file    Geocoder JS.
 * @summary Geocoder: A JavaScript API for creating a location search control in a web page.
 * @author  Joseph Vrabel, U.S. Geological Survey <jvrabel@usgs.gov>
 * @version 1.0.0
 * @preserve
 */
window.gc=window.gc||{},gc.create=((e,t={})=>{const n={bounds:void 0,states:void 0,include:"gnis postal state",controlClassName:"",className:"",maxSuggestions:50,menuClassName:"",menuHeight:"40rem",minCharacters:2,placeholder:"Find a place",size:"md",title:"",width:void 0,onSelect:void 0,onSuggest:void 0};if(!document.getElementById(e))return console.warn(`[geocoder] USAGE ERROR: Cannot create, element with id="${e}" does not exist.`);if(Object.keys(gc._controls||{}).includes(e))return console.warn(`[geocoder] USAGE ERROR: Cannot create, a geocoder control already exists in element id="${e}".`);const o={id:e,getSelected:()=>o._selected,getSuggestions:()=>o._suggestions,setOptions:(...e)=>{const t=e.length<=1?e[0]:{[e[0]]:e[1]};return"object"!=typeof t?(console.warn('[geocoder] USAGE ERROR: "setOptions" input must be an object of options or an option (name,value) pair, options not changed.'),o):(Object.keys(t).filter(e=>!Object.keys(n).includes(e)).forEach(e=>{console.warn(`[geocoder] USAGE WARNING: Unrecognized option "${e}" ignored.`),delete t[e]}),o.options=Object.assign(o.options||n,t),o._element.control.className=`gc-control gc-${o.options.size} ${o.options.className} ${o.options.controlClassName}`,o._element.control.style.width=o.options.width?isNaN(Number(o.options.width))?o.options.width:o.options.width+"px":null,o._element.input.placeholder=o.options.placeholder||"",o._element.input.title=o.options.title,o._element.menu.className=`gc-menu gc-${o.options.size} ${o.options.className} ${o.options.menuClassName}`,o._cache={},o._suggestions={type:"FeatureCollection",features:[]},o._selected=void 0,o)},enable:e=>void 0===e?!o._element.input.disabled:(o._element.input.disabled=!e,o._element.control.classList.toggle("gc-disabled",!e),o),visible:e=>void 0===e?!o._element.control.classList.contains("gc-hidden"):(o._element.control.classList.toggle("gc-hidden",!e),o),value:e=>void 0===e?o._element.input.value:(o._element.input.value=e,o),trigger:(e="")=>(e.split(/\s+/u).filter(e=>"function"==typeof o.options[e]).forEach(e=>o.options[e](o)),o),destroy:()=>{o._fetchAbortController.abort(),o._eventAbortController.abort(),o._element.control.remove(),o._element.menu.remove(),delete gc._controls[o.id];for(const e in o)delete o[e]}};return gc._create(o).setOptions(t)}),gc.get=(e=>(gc._controls||{})[e]),gc.version="1.0.0",gc.homepage="https://dashboard.waterdata.usgs.gov/api/geocoder/",gc._config={debounceMs:250,minScore:80,nCoordDecimals:6,service1:"https://dashboard.waterdata.usgs.gov/service/geocoder/get/location/"+gc.version.replace(/\.[0-9]+$/u,""),service2:"https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates",svg:{magnifier:'<svg viewBox="0 0 48 48"><path d="M 20.5 6 C 12.5 6 6 12.5 6 20.5 C 6 28.5 12.5 35 20.5 35 C 23.8 35 26.8 33.9 29.2 32.1 L 38.6 41.4 A 2 2 0 1 0 41.4 38.6 L 32 29.2 C 33.9 26.8 35 23.8 35 20.5 C 35 12.5 28.5 6 20.5 6 z M 20.5 10 C 26.3 10 31 14.7 31 20.5 C 31 23.3 29.9 25.8 28.1 27.7 A 2 2 0 0 0 27.7 28.1 C 25.8 29.9 23.3 31 20.5 31 C 14.7 31 10 26.3 10 20.5 C 10 14.7 14.7 10 20.5 10 z"/></svg>'},timeoutMs:7e3},gc._create=(e=>(gc._controls=gc._controls||{},gc._controls[e.id]=e,e._eventAbortController=new window.AbortController,e._fetchAbortController=new window.AbortController,document.getElementById(e.id).innerHTML=`<div class="gc-control">\n            <div class="gc-icon"> ${gc._config.svg.magnifier} </div>\n            <input type="search" class="gc-input" value="" spellcheck="false">\n            <div class="gc-spinner">\n                <div></div>\n            </div>\n        </div>`,e._element={control:document.querySelector(`#${e.id} .gc-control`),icon:document.querySelector(`#${e.id} .gc-icon`),input:document.querySelector(`#${e.id} .gc-input`),spinner:document.querySelector(`#${e.id} .gc-spinner`),menu:document.createElement("div")},e._element.menu.classList.add("gc-menu"),document.body.appendChild(e._element.menu),e._positionMenu=(()=>{if(!e._element.menu.innerHTML)return e;const t=e._element.control.getBoundingClientRect(),n=t.top,o=window.innerHeight-t.bottom,s=(document.fullscreenElement||document.documentElement).scrollLeft,i=(document.fullscreenElement||document.documentElement).scrollTop;e._element.menu.style.cssText=`width:      ${e._element.control.offsetWidth}px;\n             left:       ${t.left+s}px;\n             top:        ${o>=n?t.bottom+i+"px":null};\n             bottom:     ${o<n?document.documentElement.clientHeight-(t.top+i)+"px":null};\n             box-shadow: 0 ${o>=n?"5px":"-5px"} 10px 0 rgba(0,0,0,0.3);`;const a=e._element.menu.querySelector(".gc-menu-items"),r=.9*Math.max(n,o);return e.options.menuHeight?(a.style.maxHeight=/\D/u.test(e.options.menuHeight)?e.options.menuHeight:e.options.menuHeight+"px",a.offsetHeight>r&&(a.style.maxHeight=r+"px")):a.style.maxHeight=r+"px",e}),e._updateMenu=(t=>{if(!e._element)return e;e._element.control.classList.remove("gc-valid","gc-invalid");const n=e._suggestions.features.length;if(!(t&&n&&e.visible()&&e.enable()))return t&&!n&&e._element.control.classList.add("gc-invalid"),e._suggestions.features=[],e._element.menu.innerHTML="",e._element.menu.classList.remove("gc-open"),e._updateMenu.contentLength&&e.trigger("onSuggest"),e._updateMenu.contentLength=0,e;let o;e._element.control.classList.add("gc-valid");try{o=new RegExp("("+t.replace(/\*/gu,"").split(" ").join("|")+")","gi")}catch(e){o=new RegExp("()")}let s,i="";e._suggestions.features.forEach((e,t)=>{const a=e.properties;a.Type!==s&&(i+=`<div class="gc-menu-separator"> ${a.Type.toUpperCase()} </div>`,s=a.Type),i+=`<div class="gc-menu-item ${1===n?"gc-menu-item-active":""}" data-index="${t}">${a.Name.replace(o,'<span style="color: var(--gc-text-match)">$1</span>')+(a.County&&a.State?`<div class="gc-muted">${a.County}, ${a.State}</div>`:"")+(100!==a.Score?`<div class="gc-muted">${a.Score}% match      </div>`:"")}</div>`}),e._element.menu.innerHTML=`<div class="gc-menu-title">\n                ${n>=e.options.maxSuggestions?"Top ":""}${n} Suggestion${n>1?"s":""} <span style="float:right; cursor:pointer;">&#10006;</span>\n             </div>\n             <div class="gc-menu-items"> ${i} </div>`,e._element.menu.classList.add("gc-open"),e._positionMenu();const a=e._element.menu.innerHTML.length;return a!==e._updateMenu.contentLength&&e.trigger("onSuggest"),e._updateMenu.contentLength=a,e}),window.addEventListener("resize",e._positionMenu,{signal:e._eventAbortController.signal}),window.addEventListener("fullscreenchange",()=>(document.fullscreenElement||document.body).appendChild(e._element.menu),{signal:e._eventAbortController.signal}),window.addEventListener("scroll",t=>{t.target!==document&&t.target.contains(e._element.control)&&e._updateMenu()},{signal:e._eventAbortController.signal,capture:!0}),e._element.input.addEventListener("input",gc.debounce(()=>gc._locate(e),gc._config.debounceMs),{signal:e._eventAbortController.signal}),e._element.input.addEventListener("blur",()=>setTimeout(e._updateMenu,200),{signal:e._eventAbortController.signal}),e._element.input.addEventListener("keydown",t=>{const n=e._element.menu.querySelector(".gc-menu-item-active");switch(t.which){case 27:return e._updateMenu();case 13:return void(n&&(n.click(),e._updateMenu()));case 38:case 40:const o=e._element.menu.querySelectorAll(".gc-menu-item");if(!o.length)return;const s=38===t.which?-1:1;let i=n?Number(n.dataset.index):s<0?0:o.length-1;if(i=(10*o.length+i+s)%o.length,o.forEach((e,t)=>e.classList.toggle("gc-menu-item-active",t===i)),e.suggestionLayer){const t=e.suggestionLayer.getLayers(),n=t[0].getTooltip;document.querySelectorAll(".gc-map-marker").forEach((e,o)=>{e.classList.toggle("gc-map-marker-hover",o===i),n&&t[o][o===i?"openTooltip":"closeTooltip"]()})}const a=e._element.menu.querySelector(".gc-menu-items");return o[i].offsetTop<a.scrollTop&&(a.scrollTop=o[i].offsetTop),void(o[i].offsetHeight+o[i].offsetTop>a.offsetHeight+a.scrollTop&&(a.scrollTop=o[i].offsetHeight+o[i].offsetTop-a.offsetHeight))}},{signal:e._eventAbortController.signal}),["mouseenter","mouseleave"].forEach(t=>e._element.menu.addEventListener(t,n=>{n.target.classList.contains("gc-menu-item")&&(e._element.menu.querySelectorAll(".gc-menu-item").forEach(e=>e.classList.remove("gc-menu-item-active")),n.target.classList.toggle("gc-menu-item-active","mouseenter"===t))},{signal:e._eventAbortController.signal,capture:!0})),e._element.menu.addEventListener("click",t=>{t.stopPropagation();const n=t.target.closest(".gc-menu-item");n&&(e._selected=e._suggestions.features[n.dataset.index],e.value("").trigger("onSelect"))},{signal:e._eventAbortController.signal}),e)),gc._locate=(e=>{const t=gc._locate.parseInput(e);if(e._element.input.value.trim().length<e.options.minCharacters)return e._updateMenu();if(t.cacheKey in e._cache)return e._suggestions.features=e._cache[t.cacheKey],e._updateMenu(t.term);if(t.latlon){const n=gc._locate.getFeature(e,t,{Type:"Latitude-Longitude Coordinate",Label:`Coordinate (${t.latlon.join(", ")})`,Name:`Coordinate (${t.latlon.join(", ")})`,Latitude:t.latlon[0],Longitude:t.latlon[1],Source:"latlon"});if(n)return e._suggestions.features=[n],e._updateMenu(t.term)}e._element.control.classList.add("gc-busy"),e._suggestions.features=[],e._fetchAbortController.abort();const n=e._fetchAbortController=new window.AbortController,o=setTimeout(()=>{console.warn(`[geocoder] SERVICE ERROR: Timeout expired (${gc._config.timeoutMs/1e3} seconds).`),n.abort()},gc._config.timeoutMs),s=(s=!1)=>{clearTimeout(o),e._element.control.classList.remove("gc-busy"),n.signal.aborted||(s&&(e._cache[t.cacheKey]=e._suggestions.features),e._updateMenu(t.term))},i=(e.options.bounds||[]).flat(),a={term:t.term,states:t.states,latitudeMin:i[0],longitudeMin:i[1],latitudeMax:i[2],longitudeMax:i[3],include:e.options.include.replace(/\s+/gu,","),maxSuggestions:e.options.maxSuggestions};return Object.keys(a).forEach(e=>{void 0===a[e]&&delete a[e]}),fetch(gc._config.service1+"?"+new window.URLSearchParams(a).toString(),{signal:n.signal}).then(e=>e.json()).then(n=>{if(n.error)throw n.error;if(!Array.isArray(n))throw"Unexpected response (not array).";if(!n.length)throw"NO_API_SUGGESTIONS";e._suggestions.features=n.map(n=>gc._locate.getFeature(e,t,n)).filter(e=>e),s(!0)}).catch(o=>{if(n.signal.aborted||!e.options.include.toLowerCase().includes("gnis"))return void s(!1);"NO_API_SUGGESTIONS"!==o&&console.warn(`[geocoder] API SERVICE ERROR: "${o.details||o}" ...calling secondary service.`);const[i,a,r,l]=(e.options.bounds||[-90,-180,90,180]).flat();fetch(gc._config.service2+"?"+new window.URLSearchParams({f:"json",singleLine:t.term,sourceCountry:"USA",searchExtent:[a,i,l,r].join(","),category:"Address,Postal,Populated Place,Arts and Entertainment,Education,Land Features,Parks and Outdoors,Residence,Water Features,Airport,Bus Station,Train Station",maxLocations:e.options.maxSuggestions,outFields:["Type","Match_addr","ShortLabel","Subregion","RegionAbbr","Y","X","Ymin","Ymax","Xmin","Xmax","Score","Loc_name"].join(",")}).toString(),{signal:n.signal}).then(e=>e.json()).then(n=>{if(!n.candidates)throw"Invalid response (no candidate field).";if(!n.candidates.length)throw"NO_SECONDARY_SUGGESTIONS";const o=[];n.candidates.forEach(n=>{const s=n.attributes;if("Country"===s.Type)return;if(!s.RegionAbbr)return;const i=gc._locate.getFeature(e,t,{Type:s.Type||"Addresses and Other Suggestions",Label:s.Match_addr,Name:s.Type?s.ShortLabel:s.Match_addr,County:s.Subregion,State:s.RegionAbbr,Latitude:s.Y,Longitude:s.X,LatitudeMin:s.Ymin,LatitudeMax:s.Ymax,LongitudeMin:s.Xmin,LongitudeMax:s.Xmax,Score:s.Score,Source:"esri-"+s.Loc_name.toLowerCase()});i&&!o.find(e=>{const t=e.properties,n=i.properties;return t.Type===n.Type&&t.Name===n.Name&&t.County===n.County&&t.State===n.State})&&o.push(i)}),e._suggestions.features=o.sort((e,t)=>e.properties.Type>t.properties.Type?1:e.properties.Type<t.properties.Type?-1:e.properties.State>t.properties.State?1:e.properties.State<t.properties.State?-1:e.properties.County>t.properties.County?1:-1),s(!0)}).catch(e=>{n.signal.aborted||"NO_SECONDARY_SUGGESTIONS"===e||console.warn(`[geocoder] SECONDARY SERVICE ERROR: ${e}`),s(!1)})}),e}),gc._locate.parseInput=(e=>{const t={term:void 0,states:void 0,latlon:void 0,cacheKey:void 0};t.term=e._element.input.value.toUpperCase().replace(/[^A-Z0-9\*\-\.]/g," ").replace(/\s+/gu," ").replace(/^ST /u,"SAINT ").trim();const n=t.term.split(" ");t.states=(e.options.states||"ALL").toUpperCase();const o="AL AZ AR CA CO CT DE FL GA ID IL IN IA KS KY LA ME MD MA MI MN MS MO MT NE NV NH NJ NM NY NC ND OH OK OR PA RI SC SD TN TX UT VT VA WA WV WI WY";"48"===t.states&&(t.states=o+" DC"),"50"===t.states&&(t.states=o+" AK HI DC"),"USGS"===t.states&&(t.states=o+" AK HI DC GU PR VI"),"ALL"===t.states&&(t.states=o+" AK HI DC GU PR VI AS FM MH MP PW UM"),t.states=t.states.replace(/\s+/gu,",");const s=n.slice(-1)[0];n.length>1&&t.states.split(",").includes(s)?(t.term=n.slice(0,-1).join(" "),t.states=s):void 0===e.options.states&&(t.states=void 0),t.cacheKey=t.term+"|"+t.states,t.latlon=[NaN,NaN];const i={N:1,S:-1},a={E:1,W:-1},r=(e,t,n)=>Math.sign(e)*(Number(e)+Number(t)/60+Number(n)/3600);return 8===n.length?t.latlon=[i[n[3]]*r(n[0],n[1],n[2]),a[n[7]]*r(n[4],n[5],n[6])]:6===n.length?t.latlon=[r(n[0],n[1],n[2]),-Math.abs(r(n[3],n[4],n[5]))]:4===n.length?t.latlon=[i[n[1]]*Number(n[0]),a[n[3]]*Number(n[2])]:2===n.length&&(t.latlon=[Number(n[0]),-Math.abs(Number(n[1]))]),isNaN(t.latlon[0])||isNaN(t.latlon[1])?t.latlon=void 0:t.latlon=t.latlon.map(e=>Number(e.toFixed(gc._config.nCoordDecimals))),t}),gc._locate.getFeature=((e,t,n)=>{let o=!0;const s=`${n.Name} (${[n.County,n.State].filter(e=>e).join(" ")})`.replace(" ( )",""),i=10**-gc._config.nCoordDecimals,a=e=>Number(e.toFixed(gc._config.nCoordDecimals)),[r,l,c,d]=(e.options.bounds||[-90,-180,90,180]).flat();return[{name:"County",type:"string",default:""},{name:"GnisId",type:"number",default:null},{name:"Label",type:"string",default:s},{name:"Latitude",type:"number",validate:e=>e>=r&&e<=c,format:e=>a(e)},{name:"LatitudeMax",type:"number",default:n.Latitude+i,format:e=>a(e)},{name:"LatitudeMin",type:"number",default:n.Latitude-i,format:e=>a(e)},{name:"Longitude",type:"number",validate:e=>e>=l&&e<=d,format:e=>a(e)},{name:"LongitudeMax",type:"number",default:n.Longitude+i,format:e=>a(e)},{name:"LongitudeMin",type:"number",default:n.Longitude-i,format:e=>a(e)},{name:"Name",type:"string"},{name:"Score",type:"number",default:100,validate:e=>e>=gc._config.minScore,format:e=>Math.round(e)},{name:"Source",type:"string"},{name:"State",type:"string",default:"",validate:e=>!t.states||t.states.split(",").includes(e),format:e=>e.toUpperCase()},{name:"Type",type:"string"}].forEach(e=>{let t=n[e.name];t="string"===e.type?(t||"").toString().trim():"number"===e.type?parseFloat(t):t,["",NaN].includes(t)&&(void 0!==e.default?t=e.default:(console.warn(`[geocoder] API ERROR: Required property missing or invalid type: "${e.name}"`),o=!1)),e.validate&&!e.validate(t)&&(o=!1),n[e.name]=e.format?e.format(t):t}),o?{type:"Feature",geometry:{type:"Point",coordinates:[n.Longitude,n.Latitude]},properties:Object.assign(n,{Bounds:[[n.LatitudeMin,n.LongitudeMin],[n.LatitudeMax,n.LongitudeMax]]})}:void 0}),gc.debounce=((e,t=250)=>{let n;return function(...o){n&&clearTimeout(n),n=setTimeout(()=>e(...o),t)}}),window.L&&L.Map&&(L.Control.Geocoder=L.Control.extend({defaultOptions:{position:"topright",id:void 0,interaction:"select",size:"sm"},get:function(){return this._geocoderControl},onAdd:function(e){const t=this,n=document.createElement("div");n.id=t.options.id||`Geocoder${Math.floor(1e6*Math.random())}`,document.body.append(n);const o=Object.assign({},t.defaultOptions,t.options),s=o.interaction;delete o.interaction,delete o.id,delete o.position;const i=gc.create(n.id,o);return i._map=e,t._geocoderControl=i,L.DomEvent.disableClickPropagation(n),L.DomEvent.disableScrollPropagation(n),L.DomEvent.disableClickPropagation(i._element.menu),L.DomEvent.disableScrollPropagation(i._element.menu),!["select","suggest"].includes(s)||o.onSelect||o.onSuggest||i.setOptions("onSelect",t=>{const o=t.getSelected().properties;e.fitBounds(o.Bounds,{maxZoom:10}).openPopup(`\n                        <div style="min-width:150px; font-size:1rem;">\n                            <div class="gc-muted"       >${o.Type.toUpperCase()}</div>\n                            <div style="font-size:120%;">${o.Name}</div>\n                            <div class="gc-muted"       >${o.County&&o.State?o.County+", "+o.State:""}</div>\n                            <div style="display:flex; justify-content:space-between; margin-top:3px;">\n                                <a href="javascript: gc.get('${n.id}')._map.setView( [${o.Latitude},${o.Longitude}], gc.get('${n.id}')._map.getMaxZoom() ); void(0)"> Zoom </a>\n                                <a href="javascript: gc.get('${n.id}')._map.closePopup(); void(0)"> Close </a>\n                            </div>\n                        </div>`,[o.Latitude,o.Longitude],{maxWidth:300,closeButton:!1})}),!["suggest"].includes(s)||o.onSelect||o.onSuggest||(i.suggestionLayer=L.geoJson(null,{pointToLayer:(e,t)=>{const n=L.marker(t,{icon:L.divIcon({className:"gc-map-marker",html:`<div>${gc._config.svg.magnifier}</div>`,iconSize:[0,0]}),zIndexOffset:1e4}).on("click",()=>{i._selected=e,i.trigger("onSelect").value("")});return n.bindTooltip&&n.bindTooltip(()=>{const t=e.properties;return`\n                            <div style="${t.Type.length>50||t.Name.length>50?"width:300px; white-space:normal;":""} font-size:1rem;">\n                                <div class="gc-muted"       >${t.Type.toUpperCase()}</div>\n                                <div style="font-size:120%;">${t.Name}</div>\n                                <div class="gc-muted"       >${t.County&&t.State?t.County+", "+t.State:""}</div>\n                            </div>`},{direction:"top",offset:[0,-20]}),n}}),i.setOptions("onSuggest",n=>{n.suggestionLayer.clearLayers().addData(n.getSuggestions()).addTo(e);const o=n.suggestionLayer.getBounds();if(!o.isValid())return e.removeLayer(n.suggestionLayer);const s=n._element.menu.offsetWidth;e.closePopup().fitBounds(o,{paddingTopLeft:[t.getPosition().includes("left")?s:30,60],paddingBottomRight:[t.getPosition().includes("right")?s:30,30],maxZoom:8})}),["mouseenter","mouseleave"].forEach(e=>i._element.menu.addEventListener(e,t=>{if(!t.target.classList.contains("gc-menu-item"))return;const n=document.querySelectorAll(".gc-map-marker");if(n.forEach(e=>e.classList.remove("gc-map-marker-hover")),"mouseenter"===e){const e=t.target.dataset.index,o=i.suggestionLayer.getLayers()[e];o.openTooltip&&o.openTooltip(),n[e].classList.add("gc-map-marker-hover")}else i.suggestionLayer.invoke("closeTooltip")},{signal:i._eventAbortController.signal,capture:!0}))),n},onRemove:function(){this._geocoderControl.destroy()}}),L.control.geocoder=(e=>new L.Control.Geocoder(e)),L.Map.addInitHook(function(){const e=this;e.options.geocoderControl&&(e.geocoderControl=L.control.geocoder(e.options.geocoderControl).addTo(e))}));